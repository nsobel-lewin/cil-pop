---
title: "Validate IR Populations"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(furrr)
source("compute_ir_populations_fns.R")
source("validate_ir_populations_fns.R")
datadir <- "/project/cil/gcp/population/"
products <- c("landscan")
years <- c(2015, 2020, 2022)
```

# Processing 
```{r processing, eval = F}
# Get full set of products and years
specs <- expand_grid(
  datadir = datadir,
  product = products, 
  year = years)

# Compute IR-level populations
par_workers <- parallelly::availableCores()
plan(multisession, workers = par_workers)

pops <- specs %>% 
  mutate(
    unscaled_pop_df = furrr::future_pmap(., aggregate_pop_to_ir),
    scaled_pop_df = furrr::future_map2(datadir, unscaled_pop_df, ~scale_ir_pop(.x, .y))
  ) %>% 
  pivot_longer(
    matches("pop_df"), 
    values_to = "dfs") %>% 
  pull(dfs) %>% 
  bind_rows() %>% 
  rename(rescaled_to_sum_to_un_pop = rescaled)

# Export IR-level population data 
out_path <- str_c(datadir, "processed/ir_population_data.csv")
write_csv(pops, out_path)

```

# Validation
## Density plots
```{r validation-density plots, echo = F}
for (product in products) {
  for (year in years) {
    
    print(make_rescale_factor_density_plot(datadir, product, year))
    
    print(make_pop_diff_density_plot(datadir, product, year))
    
  }
}
```


## Maps
```{r validation-pop maps, echo = F}
simplified_shp <- load_simplified_shapefile(datadir)

for (product in products) {
  for (year in years) {
    for (rescaled in c(T, F)) {
      print(make_pop_plot(datadir, simplified_shp, product, year, rescaled))
    }
    print(make_pop_diff_plot(datadir, simplified_shp, product, year))
  }
}
```


